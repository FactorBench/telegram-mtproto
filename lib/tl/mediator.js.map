{"version":3,"sources":["../../src/tl/mediator.js"],"names":["log","Logger","WriteMediator","int","ctx","i","field","writeInt","bool","longP","iHigh","iLow","writePair","long","sLong","Array","isArray","length","intBytes","str","toString","int1","int2","double","f","buffer","ArrayBuffer","intView","Int32Array","doubleView","Float64Array","bytes","list","binaryDataGuard","checkLength","next","set","addPadding","bits","Error","ReadMediator","result","nextInt","res","string","sUTF8","map","getChar","join","s","decodeURIComponent","escape","e","len","nextByte","Uint8Array","byteLength","unescape","encodeURIComponent","undefined","String","fromCharCode"],"mappings":"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","file":"mediator.js","sourcesContent":["//@flow\n\nimport { TypeWriter, TypeBuffer } from './type-buffer'\nimport { longToInts, stringToChars, lshift32, bytesToHex } from '../bin'\n\nimport Logger from '../util/log'\nconst log = Logger`tl:mediator`\n\nimport type { BinaryData } from './index.h'\n\nexport const WriteMediator = {\n  int(ctx: TypeWriter, i: number, field: string = '') {\n    ctx.writeInt(i, `${ field }:int`)\n  },\n  bool(ctx: TypeWriter, i: boolean, field: string = '') {\n    if (i) {\n      ctx.writeInt(0x997275b5, `${ field }:bool`)\n    } else {\n      ctx.writeInt(0xbc799737, `${ field }:bool`)\n    }\n  },\n  longP(ctx: TypeWriter,\n        iHigh: number,\n        iLow: number,\n        field: string) {\n    ctx.writePair(iLow, iHigh,\n                  `${ field }:long[low]`,\n                  `${ field }:long[high]`)\n  },\n  long(ctx: TypeWriter,\n       sLong?: number[] | string | number,\n       field: string = '') {\n    if (Array.isArray(sLong))\n      return sLong.length === 2\n        ? this.longP(ctx, sLong[0], sLong[1], field)\n        : this.intBytes(ctx, sLong, 64, field)\n    let str\n    if (typeof sLong !== 'string')\n      str = sLong\n        ? sLong.toString()\n        : '0'\n    else str = sLong\n    const [int1, int2] = longToInts(str)\n    ctx.writePair(int2, int1,\n                  `${ field }:long[low]`,\n                  `${ field }:long[high]`)\n  },\n  double(ctx: TypeWriter, f: number, field: string = '') {\n    const buffer = new ArrayBuffer(8)\n    const intView = new Int32Array(buffer)\n    const doubleView = new Float64Array(buffer)\n\n    doubleView[0] = f\n\n    const [int1, int2] = intView\n    ctx.writePair(int2, int1,\n                  `${ field }:double[low]`,\n                  `${ field }:double[high]`)\n  },\n  bytes(ctx: TypeWriter,\n        bytes?: number[] | ArrayBuffer | string,\n        field: string = '') {\n    const { list, length } = binaryDataGuard(bytes)\n    // this.debug && console.log('>>>', bytesToHex(bytes), `${ field }:bytes`)\n\n    ctx.checkLength(length + 8)\n    if (length <= 253) {\n      ctx.next(length)\n    } else {\n      ctx.next(254)\n      ctx.next(length & 0xFF)\n      ctx.next((length & 0xFF00) >> 8)\n      ctx.next((length & 0xFF0000) >> 16)\n    }\n\n    ctx.set(list, length)\n    ctx.addPadding()\n  },\n  intBytes(ctx: TypeWriter,\n           bytes: BinaryData  | ArrayBuffer | string,\n           bits: number | false,\n           field: string = '') {\n    const { list, length } = binaryDataGuard(bytes)\n\n    if (bits) {\n      if (bits % 32 || length * 8 != bits) {\n        throw new Error(`Invalid bits: ${  bits  }, ${length}`)\n      }\n    }\n    // this.debug && console.log('>>>', bytesToHex(bytes), `${ field }:int${  bits}`)\n    ctx.checkLength(length)\n    ctx.set(list, length)\n  }\n}\n\nexport const ReadMediator = {\n  int(ctx: TypeBuffer, field: string) {\n    const result = ctx.nextInt()\n    log('read, int')(field, result)\n    return result\n  },\n  long(ctx: TypeBuffer, field: string ){\n    const iLow = this.int(ctx, `${ field }:long[low]`)\n    const iHigh = this.int(ctx, `${ field }:long[high]`)\n\n    const res = lshift32(iHigh, iLow)\n    return res\n  },\n  double(ctx: TypeBuffer, field: string) {\n    const buffer = new ArrayBuffer(8)\n    const intView = new Int32Array(buffer)\n    const doubleView = new Float64Array(buffer)\n\n    intView[0] = this.int(ctx, `${ field }:double[low]`)\n    intView[1] = this.int(ctx, `${ field }:double[high]`)\n\n    return doubleView[0]\n  },\n  string(ctx: TypeBuffer, field: string) {\n    const bytes = this.bytes(ctx, `${field}:string`)\n    const sUTF8 = [...bytes]\n      .map(getChar)\n      .join('')\n\n    let s\n    try {\n      s = decodeURIComponent(escape(sUTF8))\n    } catch (e) {\n      s = sUTF8\n    }\n\n    log(`read, string`)(s, `${field}:string`)\n\n    return s\n  },\n  bytes(ctx: TypeBuffer, field: string) {\n    let len = ctx.nextByte()\n\n    if (len == 254) {\n      len = ctx.nextByte() |\n          ctx.nextByte() << 8 |\n          ctx.nextByte() << 16\n    }\n\n    const bytes = ctx.next(len)\n    ctx.addPadding()\n\n    log(`read, bytes`)(bytesToHex(bytes), `${ field }:bytes`)\n\n    return bytes\n  }\n}\n\nconst binaryDataGuard = (bytes?: number[] | ArrayBuffer | Uint8Array | string) => {\n  let list, length\n  if (bytes instanceof ArrayBuffer) {\n    list = new Uint8Array(bytes)\n    length = bytes.byteLength\n  } else if (typeof bytes === 'string') {\n    list =\n      stringToChars(\n        unescape(\n          encodeURIComponent(\n            bytes)))\n    length = list.length\n  } else if (bytes === undefined) {\n    list = []\n    length = 0\n  } else {\n    list = bytes\n    length = bytes.length\n  }\n  return {\n    list,\n    length\n  }\n}\n\nconst getChar = (e: number) => String.fromCharCode(e)\n"]}