{"version":3,"sources":["../../../src/service/api-manager/index.js"],"names":["debug","Logger","hasPath","isNil","Ln","length","obj","ApiManager","constructor","config","tls","netFabric","on","emit","cache","uploader","downloader","auth","servers","keysParsed","fixupDc","dcID","console","log","baseDcID","networkSetter","dc","options","authKey","serverSalt","networker","networkFabric","fileUpload","fileDownload","Error","isUpload","akk","ssk","dcUrl","chooseServer","authKeyHex","storage","get","serverSaltHex","createNetworker","AuthKeyError","error","netError","set","mtpGetNetworker","method","params","deferred","rejectPromise","err","type","input","Object","message","reject","noErrorBox","initConnection","requestThunk","req","performRequest","waitTime","cfg","getNetworker","netOpts","bind","Request","then","resolve","deferResolve","apiSavedNet","apiRecall","code","mtpInvokeApi","catch","promise","setUserAuth","userAuth","fullUserAuth","user_auth","server","api","app","publicKeys","schema","mtSchema","apiConfig","serverConfig","TL","keyManager","Serialization","apiManager","requestPulls","requestActives","isAnyNetworker","storedBaseDc","baseDc","opts","nearestDc","wrapApiCall","nearest_dc","this_dc","mtpClearStorage","saveKeys","push","noPrefix","values","clear","restoreObj","forEach","key","i","value","undefined","ctx","keys","stack","Promise"],"mappings":";;;;;;;AAEA;;;;AAGA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;AAGA;;;;AAGA;;;;AACA;;AACA;;AAEA;;;;AACA;;AAEA;;AAIA;;AACA;;AAEA;;;;;;;AA7BA;;AAUA,IAAMA,QAAQC,aAAO,aAArB;;AA6BA,IAAMC,UAAU,6BAAe,0BAAYC,eAAZ,CAAf,CAAhB;;AAEA,IAAMC,KAAK,CAACC,MAAD,EAASC,GAAT,KAAiBA,OAAO,sBAAO,QAAP,EAAiBD,MAAjB,EAAyBC,GAAzB,CAAnC;;AAEO,MAAMC,UAAN,CAAiB;AAsBtBC,cAAYC,MAAZ,EAAkCC,GAAlC,EAAiDC,SAAjD,EAAsE,EAAEC,EAAF,EAAMC,IAAN,EAAtE,EAA4G;AAAA;;AAAA,SArB5GC,KAqB4G,GArB7F;AACbC,gBAAY,EADC;AAEbC,kBAAY,EAFC;AAGbC,YAAY,EAHC;AAIbC,eAAY,EAJC;AAKbC,kBAAY;AALC,KAqB6F;;AAAA,SAyC5GC,OAzC4G,GAyCjGC,IAAD,IAAU;AAClBC,cAAQC,GAAR,CAAY,oBAAZ,EAAkC,KAAKC,QAAvC,EAAiD,YAAjD,EAA+DH,IAA/D;AACA,WAAKG,QAAL,GAAgBH,IAAhB;AACD,KA5C2G;;AAAA,SA8C5GI,aA9C4G,GA8C5F,CAACC,EAAD,EAAaC,OAAb,KACd,CAACC,OAAD,EAAiBC,UAAjB,KAAkD;AAChDP,cAAQC,GAAR,CAAY,0BAAZ,EAAwCI,OAAxC;AACA,UAAMG,YAAY,KAAKC,aAAL,CAAmBL,EAAnB,EAAuBE,OAAvB,EAAgCC,UAAhC,EAA4CF,OAA5C,CAAlB;AAAA,UACEb,QAASa,QAAQK,UAAR,IAAsBL,QAAQM,YAA/B,GACE,KAAKnB,KAAL,CAAWC,QADb,GAEE,KAAKD,KAAL,CAAWE,UAHvB;;AAKA,aAAOF,MAAMY,EAAN,IAAYI,SAAnB;AACD,KAvDyG;;AAwD1F,oBAAOT,IAAP,EAAqBM,UAAuB,EAA5C,EAAmD;AACnE,UAAI,CAACN,IAAL,EAAW,MAAM,IAAIa,KAAJ,CAAU,4BAAV,CAAN;;AAEX,UAAMC,WAAWR,QAAQK,UAAR,IAAsBL,QAAQM,YAA/C;AACA,UAAMnB,QAAQqB,WAAW,MAAKrB,KAAL,CAAWC,QAAtB,GAAiC,MAAKD,KAAL,CAAWE,UAA1D;AACA;AACAM,cAAQC,GAAR,CAAY,0BAAZ,EAAwCF,IAAxC,EAA8CM,OAA9C;AACAL,cAAQC,GAAR,CAAY,4BAAZ,EAA0C,mBAAIF,IAAJ,EAAUP,KAAV,CAA1C;AACA,UAAI,mBAAIO,IAAJ,EAAUP,KAAV,CAAJ,EAAsB,OAAOA,MAAMO,IAAN,CAAP;;AAEtB,UAAMe,MAAO,KAAMf,IAAO,WAA1B;AACA,UAAMgB,MAAO,KAAMhB,IAAO,cAA1B;;AAEAC,cAAQC,GAAR,CAAY,2BAAZ,EAAyCI,QAAQM,YAAR,IAAwBN,QAAQK,UAAzE;AACA,UAAMM,QAAQ,MAAKC,YAAL,CAAkBlB,IAAlB,EAAwBM,QAAQM,YAAR,IAAwBN,QAAQK,UAAxD,CAAd;AACAV,cAAQC,GAAR,CAAY,0BAAZ,EAAwCe,KAAxC;;AAEA,UAAMb,gBAAgB,MAAKA,aAAL,CAAmBJ,IAAnB,EAAyBM,OAAzB,CAAtB;;AAEA,UAAMa,aAAa,MAAM,MAAKC,OAAL,CAAaC,GAAb,CAAiBN,GAAjB,CAAzB;AACA,UAAIO,gBAAgB,MAAM,MAAKF,OAAL,CAAaC,GAAb,CAAiBL,GAAjB,CAA1B;;AAEA,UAAIvB,MAAMO,IAAN,CAAJ,EAAiB,OAAOP,MAAMO,IAAN,CAAP;;AAEjB,UAAIjB,GAAG,GAAH,EAAQoC,UAAR,CAAJ,EAAyB;AACvB,YAAI,CAACG,aAAD,IAAkBA,cAActC,MAAd,KAAyB,EAA/C,EACEsC,gBAAgB,kBAAhB;AACF,YAAMf,WAAU,uBAAaY,UAAb,CAAhB;AACA,YAAMX,cAAa,uBAAac,aAAb,CAAnB;;AAEA,eAAOlB,cAAcG,QAAd,EAAuBC,WAAvB,CAAP;AACD;;AAED,UAAI,CAACF,QAAQiB,eAAb,EACE,MAAM,IAAIC,mBAAJ,EAAN;;AAEF,UAAI5B,aAAJ;AACA,UAAI;AACFA,eAAO,MAAM,MAAKA,IAAL,CAAUI,IAAV,EAAgB,MAAKP,KAAL,CAAWG,IAA3B,EAAiCqB,KAAjC,CAAb;AACD,OAFD,CAEE,OAAOQ,KAAP,EAAc;AACd,eAAOC,SAASD,KAAT,CAAP;AACD;;AAED,UAAM,EAAElB,OAAF,EAAWC,UAAX,KAA0BZ,IAAhC;;AAEA,YAAM,MAAKwB,OAAL,CAAaO,GAAb,CAAiBZ,GAAjB,EAAsB,qBAAWR,OAAX,CAAtB,CAAN;AACA,YAAM,MAAKa,OAAL,CAAaO,GAAb,CAAiBX,GAAjB,EAAsB,qBAAWR,UAAX,CAAtB,CAAN;;AAEA,aAAOJ,cAAcG,OAAd,EAAuBC,UAAvB,CAAP;AACD;;AAzG2G,SAwD5GoB,eAxD4G;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAoI7F,oBAAOC,MAAP,EAAuBC,MAAvB,EAAuCxB,UAAuB,EAA9D,EAAqE;AAClFL,cAAQC,GAAR,CAAY,gBAAZ,EAA8B2B,MAA9B,EAAsCC,MAAtC,EAA8CxB,OAA9C;AACA,UAAMyB,WAAW,sBAAjB;AACA,UAAMC,gBAAgB,UAACP,KAAD,EAAgB;AACpC,YAAIQ,YAAJ;AACA,YAAI,CAACR,KAAL,EACEQ,MAAM,EAAEC,MAAM,aAAR,EAAuBC,OAAO,EAA9B,EAAN,CADF,KAEK,IAAI,CAAC,kBAAGC,MAAH,EAAWX,KAAX,CAAL,EACHQ,MAAM,EAAEI,SAASZ,KAAX,EAAN,CADG,KAEAQ,MAAMR,KAAN;AACLM,iBAASO,MAAT,CAAgBL,GAAhB;;AAEA,YAAI,CAAC3B,QAAQiC,UAAb,EAAyB;AACvB;;AAEA;;;;;;AAOA,gBAAK/C,IAAL,CAAU,cAAV,EAA0BiC,KAA1B;AACD;AACF,OArBD;;AAuBAxB,cAAQC,GAAR,CAAY,kCAAZ;AACA,YAAM,MAAKsC,cAAL,EAAN;AACAvC,cAAQC,GAAR,CAAY,sCAAZ;;AAEA,UAAMuC,eAAe;AAAA,eAAY,+BAAYC,IAAIC,cAAhB,EAAgC,CAACC,QAAD,GAAY,GAA5C,CAAZ;AAAA,OAArB;;AAEA,UAAM5C,OAAOM,QAAQN,IAAR,GACTM,QAAQN,IADC,GAET,MAAM,MAAKoB,OAAL,CAAaC,GAAb,CAAiB,IAAjB,CAFV;;AAIApB,cAAQC,GAAR,CAAY,wCAAZ,EAAsDF,IAAtD,EAA4D,cAA5D,EAA4EM,OAA5E;AACA,UAAMG,YAAY,MAAM,MAAKmB,eAAL,CAAqB5B,IAArB,EAA2BM,OAA3B,CAAxB;AACAL,cAAQC,GAAR,CAAY,+BAAZ,EAA6CO,SAA7C;;AAEA,UAAMoC,MAAM;AACVpC,iBADU;AAEVJ,YAAcL,IAFJ;AAGVoB,iBAAc,MAAKA,OAHT;AAIV0B,sBAAc,MAAKlB,eAJT;AAKVmB,iBAAczC,OALJ;AAMVP,iBAAS,MAAKA,OAAL,CAAaiD,IAAb,CAAkB,KAAlB;AANC,OAAZ;AAQA,UAAMN,MAAM,IAAIO,iBAAJ,CAAYJ,GAAZ,EAAiBhB,MAAjB,EAAyBC,MAAzB,CAAZ;;AAQ0B;AAAA,eAAMrB,SAAN;AAAA;;AACF,gCAAa;AAC7BiC,YAAItD,MAAJ,CAAWqB,SAAX,GAAuBA,SAAvB;AACA,eAAOiC,IAAIC,cAAJ,EAAP;AACD;;AATPD,UAAIC,cAAJ,GACGO,IADH,CAEInB,SAASoB,OAFb,EAGI,iBAAS;AACP,YAAMC,eAAerB,SAASoB,OAA9B;AACA,YAAME,mBAAN;AACA,YAAMC,iBAAN;AAIArD,gBAAQwB,KAAR,CAAc,yBAAd,EAAuB,OAAvB,EAAgCA,MAAM8B,IAAtC,EAA4C9B,MAAMS,IAAlD,EAAwD,MAAK/B,QAA7D,EAAuEH,IAAvE;;AAEA,eAAO,8BAAayB,KAAb,EAAoBnB,OAApB,EAA6BN,IAA7B,EAAmC,MAAKG,QAAxC,EACLsB,KADK,EACEnB,OADF,EACWN,IADX,EACiB,MAAKR,IADtB,EAC4BwC,aAD5B,EAC2CS,YAD3C,EAELY,WAFK,EAEQC,SAFR,EAEmBF,YAFnB,EAEiC,MAAKI,YAFtC,EAGL,MAAKpC,OAHA,CAAP;AAID,OAhBL,EAkBGqC,KAlBH,CAkBSzB,aAlBT;;AAoBA,aAAOD,SAAS2B,OAAhB;AACD;;AA5M2G,SAoI5GF,YApI4G;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA,SA8M5GG,WA9M4G,GA8M9F,CAAC3D,IAAD,EAAe4D,QAAf,KAAiC;AAC7C,UAAMC,+BAAiB7D,IAAjB,IAA0B4D,QAA1B,CAAN;AACA,WAAKxC,OAAL,CAAaO,GAAb,CAAiB;AACftB,YAAWL,IADI;AAEf8D,mBAAWD;AAFI,OAAjB;AAIA,WAAKrE,IAAL,CAAU,SAAV,EAAqB,EAAEa,IAAIL,IAAN,EAAYJ,MAAMgE,QAAlB,EAArB;AACD,KArN2G;;AAC1G,QAAM;AACJG,YADI;AAEJC,SAFI;AAGJC,WAAK;AACH7C,eADG;AAEH8C;AAFG,OAHD;AAOJC,YAPI;AAQJC;AARI,QASFhF,MATJ;AAUA,SAAKiF,SAAL,GAAiBL,GAAjB;AACA,SAAKE,UAAL,GAAkBA,UAAlB;AACA,SAAK9C,OAAL,GAAeA,OAAf;AACA,SAAKkD,YAAL,GAAoBP,MAApB;AACA,SAAKI,MAAL,GAAcA,MAAd;AACA,SAAKC,QAAL,GAAgBA,QAAhB;AACA,SAAKlD,YAAL,GAAoB,kCAAa,KAAKzB,KAAL,CAAWI,OAAxB,EAAiCkE,MAAjC,CAApB;AACA,SAAKxE,EAAL,GAAUA,EAAV;AACA,SAAKC,IAAL,GAAYA,IAAZ;AACA,SAAK+E,EAAL,GAAUlF,GAAV;AACA,SAAKmF,UAAL,GAAkB,6BAAW,KAAKD,EAAL,CAAQE,aAAnB,EAAkCP,UAAlC,EAA8C,KAAKzE,KAAL,CAAWK,UAAzD,CAAlB;AACA,SAAKF,IAAL,GAAY,0BAAK,KAAK2E,EAAV,EAAc,KAAKC,UAAnB,CAAZ;AACA,SAAK9D,aAAL,GAAqBpB,UAAU,KAAK4B,YAAf,CAArB;AACA,SAAKsC,YAAL,GAAoB,KAAKA,YAAL,CAAkBR,IAAlB,CAAuB,IAAvB,CAApB;AACA,SAAKpB,eAAL,GAAuB,KAAKA,eAAL,CAAqBoB,IAArB,CAA0B,IAA1B,CAAvB;AACA,QAAM0B,aAAa,KAAKlB,YAAxB;AACAkB,eAAWf,WAAX,GAAyB,KAAKA,WAA9B;AACAe,eAAWnF,EAAX,GAAgB,KAAKA,EAArB;AACAmF,eAAWlF,IAAX,GAAkB,KAAKA,IAAvB;AACAkF,eAAWtD,OAAX,GAAqBA,OAArB;AACA,SAAKuD,YAAL,GAAoB,EAApB;AACA,SAAKC,cAAL,GAAsB,EAAtB;AACA,SAAKzE,QAAL,GAAgB,CAAhB;;AAEA;AACA;;AAEA,WAAOuE,UAAP;AACD;;AAmEKlC,gBAAN,GAAuB;AAAA;;AAAA;AACrBvC,cAAQC,GAAR,CAAY,8CAAZ,EAA4D,CAAC2E,eAAe,MAAf,CAA7D;AACA5E,cAAQC,GAAR,CAAY,8BAAZ,EAA4C,OAAKT,KAAjD;AACA,UAAI,CAACoF,eAAe,MAAf,CAAL,EAA2B;AACzB,YAAMC,eAAe,MAAM,OAAK1D,OAAL,CAAaC,GAAb,CAAiB,IAAjB,CAA3B;AACApB,gBAAQC,GAAR,CAAY,wCAAZ,EAAsD4E,YAAtD,EAAoE,gCAApE,EAAsG,OAAK3E,QAA3G;AACA,YAAM4E,SAASD,gBAAgB,OAAK3E,QAApC;AACA,YAAM6E,OAAO;AACXhF,gBAAM+E,MADK;AAEXxD,2BAAiB;AAFN,SAAb;AAIA,YAAMd,YAAY,MAAM,OAAKmB,eAAL,CAAqBmD,MAArB,EAA6BC,IAA7B,CAAxB;AACA,YAAMC,YAAY,MAAMxE,UAAUyE,WAAV,CACtB,mBADsB,EACD,EADC,EACGF,IADH,CAAxB;AAEA/E,gBAAQC,GAAR,CAAY,qCAAZ,EAAmD+E,SAAnD;AACA,YAAM,EAAEE,UAAF,EAAcC,OAAd,KAA0BH,SAAhC;AACA,cAAM,OAAK7D,OAAL,CAAaO,GAAb,CAAiB,IAAjB,EAAuBwD,UAAvB,CAAN;AACA,eAAKhF,QAAL,GAAgBgF,UAAhB;AACAxG,cAAO,YAAP,EAAoB,IAApB,EAA0BsG,SAA1B;AACAhF,gBAAQC,GAAR,CAAY,0CAAZ,EAAwDiF,eAAeC,OAAvE;AACA,YAAID,eAAeC,OAAnB,EAA4B;AAC1BnF,kBAAQC,GAAR,CAAY,sEAAZ,EAAoFiF,UAApF;AACA,gBAAM,OAAKvD,eAAL,CAAqBuD,UAArB,EAAiC,EAAE5D,iBAAiB,IAAnB,EAAjC,CAAN;AACD;AACF;AAxBoB;AAyBtB;;AAmFK8D,iBAAN,GAAwB;AAAA;;AAAA;AACtB,UAAMC,WAAW,EAAjB;AACA,WAAK,IAAItF,QAAO,CAAhB,EAAmBA,SAAQ,CAA3B,EAA8BA,OAA9B,EAAsC;AACpCsF,iBAASC,IAAT,CAAe,KAAMvF,KAAO,WAA5B;AACAsF,iBAASC,IAAT,CAAe,OAAQvF,KAAO,WAA9B;AACD;AACD,aAAKoB,OAAL,CAAaoE,QAAb,GANsB,CAME;;AAExB,UAAMC,SAAS,MAAM,OAAKrE,OAAL,CAAaC,GAAb,CAAiB,GAAGiE,QAApB,CAArB;;AAEA,YAAM,OAAKlE,OAAL,CAAasE,KAAb,EAAN;;AAEA,UAAMC,aAAa,EAAnB;AACAL,eAASM,OAAT,CAAiB,UAACC,GAAD,EAAMC,CAAN,EAAY;AAC3B,YAAMC,QAAQN,OAAOK,CAAP,CAAd;AACA,YAAIC,UAAU,KAAV,IAAmBA,UAAUC,SAAjC,EACEL,WAAWE,GAAX,IAAkBE,KAAlB;AACH,OAJD;AAKA,aAAK3E,OAAL,CAAaoE,QAAb;;AAEA,aAAO,OAAKpE,OAAL,CAAaO,GAAb,CAAiBgE,UAAjB,CAAP,CApBsB,CAoBc;AApBd;AAqBvB;AAjQqB;;QAAXzG,U,GAAAA,U;AAoQb,IAAM2F,iBAAkBoB,GAAD,IAAqB7D,OAAO8D,IAAP,CAAYD,IAAIxG,KAAJ,CAAUE,UAAtB,EAAkCX,MAAlC,GAA2C,CAAvF;;AAEA,IAAM0C,WAAWD,SAAS;AACxBxB,UAAQC,GAAR,CAAY,qBAAZ,EAAmCuB,KAAnC,EAA0CA,MAAM0E,KAAhD;AACA,SAAOC,mBAAQ9D,MAAR,CAAeb,KAAf,CAAP;AACD,CAHD","file":"index.js","sourcesContent":["//@flow\n\nimport Promise from 'bluebird'\n// import UpdatesManager from '../updates'\n\nimport isNil from 'ramda/src/isNil'\nimport is from 'ramda/src/is'\nimport propEq from 'ramda/src/propEq'\nimport has from 'ramda/src/has'\nimport pathSatisfies from 'ramda/src/pathSatisfies'\nimport complement from 'ramda/src/complement'\n\nimport Logger from '../../util/log'\nconst debug = Logger`api-manager`\n\nimport Auth from '../authorizer'\nimport type { Args } from '../authorizer'\n\nimport blueDefer from '../../util/defer'\nimport { dTime } from '../time-manager'\nimport { chooseServer } from '../dc-configurator'\n\nimport KeyManager from '../rsa-keys-manger'\nimport { AuthKeyError } from '../../error'\n\nimport { bytesFromHex, bytesToHex } from '../../bin'\n\nimport type { TLFabric } from '../../tl'\nimport type { TLSchema } from '../../tl/index.h'\nimport { switchErrors } from './error-cases'\nimport { delayedCall } from '../../util/smart-timeout'\n\nimport Request from './request'\n\nimport type { Bytes, PublicKey, LeftOptions, AsyncStorage, Cache } from './index.h'\n\nimport type { ApiConfig, StrictConfig } from '../main/index.h'\n\nimport type { Networker } from '../networker'\n\nimport type { Emit, On } from '../main/index.h'\n\nconst hasPath = pathSatisfies( complement( isNil ) )\n\nconst Ln = (length, obj) => obj && propEq('length', length, obj)\n\nexport class ApiManager {\n  cache: Cache = {\n    uploader  : {},\n    downloader: {},\n    auth      : {},\n    servers   : {},\n    keysParsed: {}\n  }\n  apiConfig: ApiConfig\n  publicKeys: PublicKey[]\n  storage: AsyncStorage\n  TL: TLFabric\n  serverConfig: {}\n  schema: TLSchema\n  mtSchema: TLSchema\n  keyManager: Args\n  networkFabric: any\n  updatesManager: any\n  auth: any\n  on: On\n  emit: Emit\n  chooseServer: (dcID: number, upload?: boolean) => {}\n  constructor(config: StrictConfig, tls: TLFabric, netFabric: Function, { on, emit }: { on: On, emit: Emit }) {\n    const {\n      server,\n      api,\n      app: {\n        storage,\n        publicKeys\n      },\n      schema,\n      mtSchema\n    } = config\n    this.apiConfig = api\n    this.publicKeys = publicKeys\n    this.storage = storage\n    this.serverConfig = server\n    this.schema = schema\n    this.mtSchema = mtSchema\n    this.chooseServer = chooseServer(this.cache.servers, server)\n    this.on = on\n    this.emit = emit\n    this.TL = tls\n    this.keyManager = KeyManager(this.TL.Serialization, publicKeys, this.cache.keysParsed)\n    this.auth = Auth(this.TL, this.keyManager)\n    this.networkFabric = netFabric(this.chooseServer)\n    this.mtpInvokeApi = this.mtpInvokeApi.bind(this)\n    this.mtpGetNetworker = this.mtpGetNetworker.bind(this)\n    const apiManager = this.mtpInvokeApi\n    apiManager.setUserAuth = this.setUserAuth\n    apiManager.on = this.on\n    apiManager.emit = this.emit\n    apiManager.storage = storage\n    this.requestPulls = {}\n    this.requestActives = {}\n    this.baseDcID = 2\n\n    // this.updatesManager = UpdatesManager(apiManager)\n    // apiManager.updates = this.updatesManager\n\n    return apiManager\n  }\n  \n  fixupDc = (dcID) => {\n    console.log('[fixupDc] current:', this.baseDcID, 'candidate:', dcID)\n    this.baseDcID = dcID\n  }\n\n  networkSetter = (dc: number, options: LeftOptions) =>\n    (authKey: Bytes, serverSalt: Bytes): Networker => {\n      console.log('[networkSetter] options:', options)\n      const networker = this.networkFabric(dc, authKey, serverSalt, options),\n        cache = (options.fileUpload || options.fileDownload)\n                ? this.cache.uploader\n                : this.cache.downloader\n\n      return cache[dc] = networker\n    }\n  mtpGetNetworker = async (dcID: number, options: LeftOptions = {}) => {\n    if (!dcID) throw new Error('get Networker without dcID')\n\n    const isUpload = options.fileUpload || options.fileDownload\n    const cache = isUpload ? this.cache.uploader : this.cache.downloader\n    //const cache = this.cache.downloader\n    console.log('[MtpGetNetworker] dcID =', dcID, options)\n    console.log('[MtpGetNetworker] cached =', has(dcID, cache))\n    if (has(dcID, cache)) return cache[dcID]\n\n    const akk = `dc${  dcID  }_auth_key`\n    const ssk = `dc${  dcID  }_server_salt`\n\n    console.log('[MtpGetNetworker] upload:', options.fileDownload || options.fileUpload)\n    const dcUrl = this.chooseServer(dcID, options.fileDownload || options.fileUpload)\n    console.log('[MtpGetNetworker] dcUrl:', dcUrl)\n\n    const networkSetter = this.networkSetter(dcID, options)\n\n    const authKeyHex = await this.storage.get(akk)\n    let serverSaltHex = await this.storage.get(ssk)\n\n    if (cache[dcID]) return cache[dcID]\n\n    if (Ln(512, authKeyHex)) {\n      if (!serverSaltHex || serverSaltHex.length !== 16)\n        serverSaltHex = 'AAAAAAAAAAAAAAAA'\n      const authKey = bytesFromHex(authKeyHex)\n      const serverSalt = bytesFromHex(serverSaltHex)\n\n      return networkSetter(authKey, serverSalt)\n    }\n\n    if (!options.createNetworker)\n      throw new AuthKeyError()\n\n    let auth\n    try {\n      auth = await this.auth(dcID, this.cache.auth, dcUrl)\n    } catch (error) {\n      return netError(error)\n    }\n\n    const { authKey, serverSalt } = auth\n\n    await this.storage.set(akk, bytesToHex(authKey))\n    await this.storage.set(ssk, bytesToHex(serverSalt))\n\n    return networkSetter(authKey, serverSalt)\n  }\n  async initConnection() {\n    console.log('[initConnection] check exists any networker:', !isAnyNetworker(this))\n    console.log('[initConnection] networkers:', this.cache)\n    if (!isAnyNetworker(this)) {\n      const storedBaseDc = await this.storage.get('dc')\n      console.log('[initConnection] stored default dc id:', storedBaseDc, '. While default from settings:', this.baseDcID)\n      const baseDc = storedBaseDc || this.baseDcID\n      const opts = {\n        dcID: baseDc,\n        createNetworker: true\n      }\n      const networker = await this.mtpGetNetworker(baseDc, opts)\n      const nearestDc = await networker.wrapApiCall(\n        'help.getNearestDc', {}, opts)\n      console.log('[initConnection] help.getNearestDc:', nearestDc)\n      const { nearest_dc, this_dc } = nearestDc\n      await this.storage.set('dc', nearest_dc)\n      this.baseDcID = nearest_dc\n      debug(`nearest Dc`)('%O', nearestDc)\n      console.log('[initConnection] is nearest is not this:', nearest_dc !== this_dc)\n      if (nearest_dc !== this_dc) {\n        console.log('[initConnection] if nearest_dc != this_dc. create networker for dcID', nearest_dc)\n        await this.mtpGetNetworker(nearest_dc, { createNetworker: true })\n      }\n    }\n  }\n  mtpInvokeApi = async (method: string, params: Object, options: LeftOptions = {}) => {\n    console.log('[mtpInvokeApi]', method, params, options)\n    const deferred = blueDefer()\n    const rejectPromise = (error: any) => {\n      let err\n      if (!error)\n        err = { type: 'ERROR_EMPTY', input: '' }\n      else if (!is(Object, error))\n        err = { message: error }\n      else err = error\n      deferred.reject(err)\n\n      if (!options.noErrorBox) {\n        //TODO weird code. `error` changed after `.reject`?\n\n        /*err.input = method\n\n        err.stack =\n          stack ||\n          hasPath(['originalError', 'stack'], error) ||\n          error.stack ||\n          (new Error()).stack*/\n        this.emit('error.invoke', error)\n      }\n    }\n\n    console.log('[mtpInvokeApi] initConnection...')\n    await this.initConnection()\n    console.log('[mtpInvokeApi] initConnection passed')\n\n    const requestThunk = waitTime => delayedCall(req.performRequest, +waitTime * 1e3)\n\n    const dcID = options.dcID\n      ? options.dcID\n      : await this.storage.get('dc')\n\n    console.log('[mtpInvokeApi] get networker with dcID', dcID, ' and options', options)\n    const networker = await this.mtpGetNetworker(dcID, options)\n    console.log('[mtpInvokeApi] got networker:', networker)\n\n    const cfg = {\n      networker,\n      dc          : dcID,\n      storage     : this.storage,\n      getNetworker: this.mtpGetNetworker,\n      netOpts     : options,\n      fixupDc: this.fixupDc.bind(this)\n    }\n    const req = new Request(cfg, method, params)\n\n\n    req.performRequest()\n      .then(\n        deferred.resolve,\n        error => {\n          const deferResolve = deferred.resolve\n          const apiSavedNet = () => networker\n          const apiRecall = networker => {\n            req.config.networker = networker\n            return req.performRequest()\n          }\n          console.error(dTime(), 'Error', error.code, error.type, this.baseDcID, dcID)\n\n          return switchErrors(error, options, dcID, this.baseDcID)(\n            error, options, dcID, this.emit, rejectPromise, requestThunk,\n            apiSavedNet, apiRecall, deferResolve, this.mtpInvokeApi,\n            this.storage)\n        }\n      )\n      .catch(rejectPromise)\n\n    return deferred.promise\n  }\n\n  setUserAuth = (dcID: number, userAuth: any) => {\n    const fullUserAuth = { dcID, ...userAuth }\n    this.storage.set({\n      dc       : dcID,\n      user_auth: fullUserAuth\n    })\n    this.emit('auth.dc', { dc: dcID, auth: userAuth })\n  }\n  async mtpClearStorage() {\n    const saveKeys = []\n    for (let dcID = 1; dcID <= 5; dcID++) {\n      saveKeys.push(`dc${  dcID  }_auth_key`)\n      saveKeys.push(`t_dc${  dcID  }_auth_key`)\n    }\n    this.storage.noPrefix() //TODO Remove noPrefix\n\n    const values = await this.storage.get(...saveKeys)\n\n    await this.storage.clear()\n\n    const restoreObj = {}\n    saveKeys.forEach((key, i) => {\n      const value = values[i]\n      if (value !== false && value !== undefined)\n        restoreObj[key] = value\n    })\n    this.storage.noPrefix()\n\n    return this.storage.set(restoreObj) //TODO definitely broken\n  }\n}\n\nconst isAnyNetworker = (ctx: ApiManager) => Object.keys(ctx.cache.downloader).length > 0\n\nconst netError = error => {\n  console.log('Get networker error', error, error.stack)\n  return Promise.reject(error)\n}\n"]}